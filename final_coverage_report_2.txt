============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\Usuario\Desktop\PC\UNI\TERCERO\TAP\PRACTICA\Minecraft_Multi-Agent_Framework\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\Usuario\Desktop\PC\UNI\TERCERO\TAP\PRACTICA\Minecraft_Multi-Agent_Framework
configfile: pytest.ini
plugins: asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 100 items

Multi-Agent_System/tests/test_agent_factory.py::test_singleton_behavior PASSED [  1%]
Multi-Agent_System/tests/test_agent_factory.py::test_register_valid_agent PASSED [  2%]
Multi-Agent_System/tests/test_agent_factory.py::test_register_invalid_agent_raises_error PASSED [  3%]
Multi-Agent_System/tests/test_agent_factory.py::test_create_agent PASSED [  4%]
Multi-Agent_System/tests/test_agent_factory.py::test_create_unregistered_agent_raises_error PASSED [  5%]
Multi-Agent_System/tests/test_agent_manager.py::test_initialization PASSED [  6%]
Multi-Agent_System/tests/test_agent_manager.py::test_setup_subscriptions PASSED [  7%]
Multi-Agent_System/tests/test_agent_manager.py::test_create_agent_success PASSED [  8%]
Multi-Agent_System/tests/test_agent_manager.py::test_create_agent_already_exists PASSED [  9%]
Multi-Agent_System/tests/test_agent_manager.py::test_create_agent_failure PASSED [ 10%]
Multi-Agent_System/tests/test_agent_manager.py::test_handle_create_command PASSED [ 11%]
Multi-Agent_System/tests/test_agent_manager.py::test_handle_message_create PASSED [ 12%]
Multi-Agent_System/tests/test_agent_manager.py::test_handle_message_workflow PASSED [ 13%]
Multi-Agent_System/tests/test_agent_manager.py::test_run_loop PASSED     [ 14%]
Multi-Agent_System/tests/test_base_agent.py::test_initial_state PASSED   [ 15%]
Multi-Agent_System/tests/test_base_agent.py::test_state_transition PASSED [ 16%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_pause PASSED [ 17%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_stop PASSED [ 18%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_update PASSED [ 19%]
Multi-Agent_System/tests/test_base_agent.py::test_run_cycle_execution PASSED [ 20%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_incoming_message_filtering PASSED [ 21%]
Multi-Agent_System/tests/test_base_agent.py::test_set_state_side_effects PASSED [ 22%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_status_help PASSED [ 23%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_resume PASSED [ 24%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_simple PASSED [ 25%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_with_namespace PASSED [ 26%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_with_properties PASSED [ 27%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_fallbacks PASSED [ 28%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_unknown_default PASSED [ 29%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_name_found PASSED [ 30%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_name_not_found PASSED [ 31%]
Multi-Agent_System/tests/test_builder_bot.py::test_initialization PASSED [ 32%]
Multi-Agent_System/tests/test_builder_bot.py::test_handle_command_plan_list PASSED [ 33%]
Multi-Agent_System/tests/test_builder_bot.py::test_handle_command_plan_set_success PASSED [ 34%]
Multi-Agent_System/tests/test_builder_bot.py::test_handle_command_build PASSED [ 35%]
Multi-Agent_System/tests/test_builder_bot.py::test_perceive_map PASSED   [ 36%]
Multi-Agent_System/tests/test_builder_bot.py::test_decide_analyzing_map PASSED [ 37%]
Multi-Agent_System/tests/test_builder_bot.py::test_decide_waiting_materials PASSED [ 38%]
Multi-Agent_System/tests/test_builder_bot.py::test_act_start_building PASSED [ 39%]
Multi-Agent_System/tests/test_builder_bot.py::test_build_structure_task_logic PASSED [ 40%]
Multi-Agent_System/tests/test_chat_listener.py::test_initialization PASSED [ 41%]
Multi-Agent_System/tests/test_chat_listener.py::test_stop PASSED         [ 42%]
Multi-Agent_System/tests/test_chat_listener.py::test_listen_processing_messages PASSED [ 43%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_init_creates_dir PASSED [ 44%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_make_serializable PASSED [ 45%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_save_and_load PASSED [ 46%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_load_non_existent PASSED [ 47%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_load_corrupt_json PASSED [ 48%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_clear_prev_checkpoints PASSED [ 49%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_save_error_handling PASSED [ 50%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_decompose_to_rectangles PASSED [ 51%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_handle_command_start PASSED [ 52%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_handle_command_set PASSED [ 53%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_decide_logic PASSED [ 54%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_act_execution PASSED [ 55%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_scan_and_find_zones_mocked PASSED [ 56%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_scan_pausing PASSED [ 57%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_resume_command PASSED [ 58%]
Multi-Agent_System/tests/test_integration_workflow.py::TestIntegrationWorkflow::test_workflow_execution_flow PASSED [ 59%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_valid_message PASSED [ 60%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_missing_fields PASSED [ 61%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_invalid_types PASSED [ 62%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_invalid_timestamp PASSED [ 63%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_invalid_status PASSED [ 64%]
Multi-Agent_System/tests/test_message_bus.py::test_register_agent PASSED [ 65%]
Multi-Agent_System/tests/test_message_bus.py::test_subscribe_agent PASSED [ 66%]
Multi-Agent_System/tests/test_message_bus.py::test_subscribe_unregistered_agent_raises_error PASSED [ 67%]
Multi-Agent_System/tests/test_message_bus.py::test_publish_subscribe_delivery PASSED [ 68%]
Multi-Agent_System/tests/test_message_bus.py::test_publish_direct_delivery PASSED [ 69%]
Multi-Agent_System/tests/test_message_bus.py::test_receive_unregistered_raises_error PASSED [ 70%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_valid_command_with_params PASSED [ 71%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_command_with_string_and_int_params PASSED [ 72%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_invalid_command_formatting PASSED [ 73%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_unknown_agent PASSED [ 74%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_process_bom_resets_inventory FAILED [ 75%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_decide_priorities FAILED [ 76%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_act_mine_physical PASSED [ 77%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_act_initial_mine PASSED [ 78%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_handle_command_start_manual FAILED [ 79%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_handle_command_set_strategy PASSED [ 80%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_load_strategy_dynamically PASSED [ 81%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_byte PASSED [ 82%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_short PASSED [ 83%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_int PASSED [ 84%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_long PASSED [ 85%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_float_double PASSED [ 86%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_string PASSED [ 87%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_int_array PASSED [ 88%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_long_array PASSED [ 89%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_list PASSED [ 90%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_load_error PASSED [ 91%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_decode_block_data PASSED [ 92%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_get_blocks_and_bom PASSED [ 93%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_get_blocks_nested_format PASSED [ 94%]
Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_grid_next_position FAILED [ 95%]
Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_vertical_strategy FAILED [ 96%]
Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_vein_strategy FAILED [ 97%]
Multi-Agent_System/tests/test_synchronization.py::TestSynchronization::test_ensure_agent_waits_for_idle PASSED [ 98%]
Multi-Agent_System/tests/test_unit_core.py::TestUnitCore::test_message_parser_init PASSED [ 99%]
Multi-Agent_System/tests/test_unit_core.py::TestUnitCore::test_message_bus_pub_sub PASSED [100%]

================================== FAILURES ===================================
_______________ TestMinerBot.test_process_bom_resets_inventory ________________

self = <tests.test_miner_bot.TestMinerBot object at 0x000002ABF16AE240>
bot = <agents.miner_bot.MinerBot object at 0x000002ABF177E0C0>

    def test_process_bom_resets_inventory(self, bot):
        payload = {
            "requirements": {"stone": 10, "diamond": 1},
            "build_position": (10, 64, 10)
        }
        with patch('agents.miner_bot.get_block_id', return_value=1):
>            bot._process_bom(payload)

Multi-Agent_System\tests\test_miner_bot.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
Multi-Agent_System\src\agents\miner_bot.py:173: in _process_bom
    asyncio.create_task(self.set_state(State.RUNNING, "BOM Processed"))
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

coro = <coroutine object BaseAgent.set_state at 0x000002ABF15B9300>

    def create_task(coro, *, name=None, context=None):
        """Schedule the execution of a coroutine object in a spawn task.
    
        Return a Task object.
        """
>       loop = events.get_running_loop()
               ^^^^^^^^^^^^^^^^^^^^^^^^^
E       RuntimeError: no running event loop

C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.12_3.12.2800.0_x64__qbz5n2kfra8p0\Lib\asyncio\tasks.py:417: RuntimeError
_____________________ TestMinerBot.test_decide_priorities _____________________

self = <tests.test_miner_bot.TestMinerBot object at 0x000002ABF16AE5A0>
bot = <agents.miner_bot.MinerBot object at 0x000002ABF179D160>

    @pytest.mark.asyncio
    async def test_decide_priorities(self, bot):
        bot.state = State.RUNNING
        bot.context['mining_active'] = True
    
        # Case 1: Not arrived at mine
        bot.context['arrived_at_mine'] = False
        bot.context['target_x'] = 100
        await bot.decide()
>       assert bot.context['next_action'] == 'initial_mine'
E       AssertionError: assert 'finish_delivery' == 'initial_mine'
E         
E         - initial_mine
E         + finish_delivery

Multi-Agent_System\tests\test_miner_bot.py:41: AssertionError
________________ TestMinerBot.test_handle_command_start_manual ________________

self = <tests.test_miner_bot.TestMinerBot object at 0x000002ABF16AF260>
bot = <agents.miner_bot.MinerBot object at 0x000002ABF1742420>

    @pytest.mark.asyncio
    async def test_handle_command_start_manual(self, bot):
        await bot.handle_command("start", {"x": 50, "z": 50})
        assert bot.context['target_x'] == 50
        assert bot.context['target_z'] == 50
>       assert bot.state == State.RUNNING
E       AssertionError: assert <State.IDLE: 'IDLE'> == <State.RUNNING: 'RUNNING'>
E        +  where <State.IDLE: 'IDLE'> = <agents.miner_bot.MinerBot object at 0x000002ABF1742420>.state
E        +  and   <State.RUNNING: 'RUNNING'> = State.RUNNING

Multi-Agent_System\tests\test_miner_bot.py:101: AssertionError
___________________ TestStrategies.test_grid_next_position ____________________

self = <tests.test_strategies.TestStrategies object at 0x000002ABF16C1190>
mock_agent = <MagicMock id='2937514420048'>

    def test_grid_next_position(self, mock_agent):
        st = GridStrategy(mock_agent.mc, mock_agent.logger, mock_agent.id)
        # Setup context
        mock_agent.context = {
            "current_y": 10,
            "target_z": 100,
            "target_x": 100,
            "grid_spacing": 2
        }
    
>       st.execute(mock_agent.context)
        ^^^^^^^^^^
E       AttributeError: 'GridStrategy' object has no attribute 'execute'

Multi-Agent_System\tests\test_strategies.py:32: AttributeError
____________________ TestStrategies.test_vertical_strategy ____________________

self = <tests.test_strategies.TestStrategies object at 0x000002ABF16C0D70>
mock_agent = <MagicMock id='2937514757056'>

    def test_vertical_strategy(self, mock_agent):
        st = VerticalStrategy(mock_agent.mc, mock_agent.logger, mock_agent.id)
        mock_agent.context = {"current_y": 60, "target_depth": 10}
    
        # Mock getBlock to return AIR (0) -> Move down
        mock_agent.mc.getBlock.return_value = 0
    
>       st.execute(mock_agent.context)
        ^^^^^^^^^^
E       AttributeError: 'VerticalStrategy' object has no attribute 'execute'

Multi-Agent_System\tests\test_strategies.py:43: AttributeError
______________________ TestStrategies.test_vein_strategy ______________________

self = <tests.test_strategies.TestStrategies object at 0x000002ABF16C0770>
mock_agent = <MagicMock id='2937514754176'>

    def test_vein_strategy(self, mock_agent):
        st = VeinStrategy(mock_agent.mc, mock_agent.logger, mock_agent.id)
        mock_agent.context = {}
        # Ensure instantiation
>       assert hasattr(st, 'execute')
E       AssertionError: assert False
E        +  where False = hasattr(<strategies.vein_strategy.VeinStrategy object at 0x000002ABF1860590>, 'execute')

Multi-Agent_System\tests\test_strategies.py:49: AssertionError
=============================== tests coverage ================================
______________ coverage: platform win32, python 3.12.10-final-0 _______________

Name                                                     Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------
Multi-Agent_System\src\agents\agent_factory.py              22      0   100%
Multi-Agent_System\src\agents\agent_manager.py              61      6    90%   40-42, 57, 87-88
Multi-Agent_System\src\agents\base_agent.py                103     10    90%   31, 35, 39, 90-91, 94-95, 103-105
Multi-Agent_System\src\agents\builder_bot.py               302    128    58%   38-41, 44-45, 49-58, 73-74, 94-105, 113, 124-125, 129-131, 143-147, 157, 170-172, 200-207, 217-239, 248-249, 266-269, 273-276, 315-319, 328-340, 343-357, 360-371, 394-395, 415-418, 423-440, 457-469
Multi-Agent_System\src\agents\explorer_bot.py              374    118    68%   22-30, 40-41, 60, 64-69, 81-82, 89-90, 209-253, 258, 277-279, 332-334, 338-341, 350-354, 382, 421, 424-426, 439-440, 445-448, 452, 454-456, 461-465, 471-485, 489-490, 504-505, 525-535, 563-577
Multi-Agent_System\src\agents\miner_bot.py                 323    185    43%   61-67, 70-71, 74-111, 137, 150, 176-183, 187-188, 194-220, 228-233, 239, 242-249, 260, 277-290, 295-298, 301-304, 320-325, 328, 334-383, 386-393, 396-403, 406-412, 420-425, 428-430, 440-443, 452-459, 475-479
Multi-Agent_System\src\agents\state_model.py                 8      0   100%
Multi-Agent_System\src\agents\workflow_manager.py           67      4    94%   65, 69-71
Multi-Agent_System\src\messages\chat_listener.py            25      3    88%   42-44
Multi-Agent_System\src\messages\message_bus.py              58      6    90%   61-63, 88, 100, 109
Multi-Agent_System\src\messages\message_parser.py          122     54    56%   69-71, 75-76, 80-81, 106, 123-152, 156-178, 192-200
Multi-Agent_System\src\strategies\grid_strategy.py          40     24    40%   27-61
Multi-Agent_System\src\strategies\mining_strategy.py        12      1    92%   30
Multi-Agent_System\src\strategies\vein_strategy.py          71     57    20%   25-116
Multi-Agent_System\src\strategies\vertical_strategy.py      39     26    33%   24-69
Multi-Agent_System\src\utils\block_translator.py            38      0   100%
Multi-Agent_System\src\utils\checkpoints.py                 53      2    96%   48, 84
Multi-Agent_System\src\utils\json_schema.py                 34      6    82%   30, 40, 44, 48, 62, 70
Multi-Agent_System\src\utils\logging.py                     52      9    83%   16-23, 50
Multi-Agent_System\src\utils\reflection.py                  64     10    84%   21-22, 41-42, 56-57, 76-77, 102-103
Multi-Agent_System\src\utils\schematic_parser.py           170      6    96%   25, 39, 41, 43, 48, 70
--------------------------------------------------------------------------------------
TOTAL                                                     2038    655    68%
Coverage XML written to file coverage.xml
=========================== short test summary info ===========================
FAILED Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_process_bom_resets_inventory
FAILED Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_decide_priorities
FAILED Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_handle_command_start_manual
FAILED Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_grid_next_position
FAILED Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_vertical_strategy
FAILED Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_vein_strategy
======================== 6 failed, 94 passed in 7.92s =========================
