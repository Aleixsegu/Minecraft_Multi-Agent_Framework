============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\Usuario\Desktop\PC\UNI\TERCERO\TAP\PRACTICA\Minecraft_Multi-Agent_Framework\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\Usuario\Desktop\PC\UNI\TERCERO\TAP\PRACTICA\Minecraft_Multi-Agent_Framework
configfile: pytest.ini
plugins: asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 106 items

Multi-Agent_System/tests/test_agent_factory.py::test_singleton_behavior PASSED [  0%]
Multi-Agent_System/tests/test_agent_factory.py::test_register_valid_agent PASSED [  1%]
Multi-Agent_System/tests/test_agent_factory.py::test_register_invalid_agent_raises_error PASSED [  2%]
Multi-Agent_System/tests/test_agent_factory.py::test_create_agent PASSED [  3%]
Multi-Agent_System/tests/test_agent_factory.py::test_create_unregistered_agent_raises_error PASSED [  4%]
Multi-Agent_System/tests/test_agent_manager.py::test_initialization PASSED [  5%]
Multi-Agent_System/tests/test_agent_manager.py::test_setup_subscriptions PASSED [  6%]
Multi-Agent_System/tests/test_agent_manager.py::test_create_agent_success PASSED [  7%]
Multi-Agent_System/tests/test_agent_manager.py::test_create_agent_already_exists PASSED [  8%]
Multi-Agent_System/tests/test_agent_manager.py::test_create_agent_failure PASSED [  9%]
Multi-Agent_System/tests/test_agent_manager.py::test_handle_create_command PASSED [ 10%]
Multi-Agent_System/tests/test_agent_manager.py::test_handle_message_create PASSED [ 11%]
Multi-Agent_System/tests/test_agent_manager.py::test_handle_message_workflow PASSED [ 12%]
Multi-Agent_System/tests/test_agent_manager.py::test_run_loop PASSED     [ 13%]
Multi-Agent_System/tests/test_base_agent.py::test_initial_state PASSED   [ 14%]
Multi-Agent_System/tests/test_base_agent.py::test_state_transition PASSED [ 15%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_pause PASSED [ 16%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_stop PASSED [ 16%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_update PASSED [ 17%]
Multi-Agent_System/tests/test_base_agent.py::test_run_cycle_execution PASSED [ 18%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_incoming_message_filtering PASSED [ 19%]
Multi-Agent_System/tests/test_base_agent.py::test_set_state_side_effects PASSED [ 20%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_status_help PASSED [ 21%]
Multi-Agent_System/tests/test_base_agent.py::test_handle_command_resume PASSED [ 22%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_simple PASSED [ 23%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_with_namespace PASSED [ 24%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_with_properties PASSED [ 25%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_fallbacks PASSED [ 26%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_id_unknown_default PASSED [ 27%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_name_found PASSED [ 28%]
Multi-Agent_System/tests/test_block_translator.py::TestBlockTranslator::test_get_block_name_not_found PASSED [ 29%]
Multi-Agent_System/tests/test_builder_bot.py::test_initialization PASSED [ 30%]
Multi-Agent_System/tests/test_builder_bot.py::test_handle_command_plan_list PASSED [ 31%]
Multi-Agent_System/tests/test_builder_bot.py::test_handle_command_plan_set_success PASSED [ 32%]
Multi-Agent_System/tests/test_builder_bot.py::test_handle_command_build PASSED [ 33%]
Multi-Agent_System/tests/test_builder_bot.py::test_perceive_map PASSED   [ 33%]
Multi-Agent_System/tests/test_builder_bot.py::test_decide_analyzing_map PASSED [ 34%]
Multi-Agent_System/tests/test_builder_bot.py::test_decide_waiting_materials PASSED [ 35%]
Multi-Agent_System/tests/test_builder_bot.py::test_act_start_building PASSED [ 36%]
Multi-Agent_System/tests/test_builder_bot.py::test_build_structure_task_logic PASSED [ 37%]
Multi-Agent_System/tests/test_builder_bot.py::test_build_structure_task_pause FAILED [ 38%]
Multi-Agent_System/tests/test_builder_bot.py::test_build_structure_task_error PASSED [ 39%]
Multi-Agent_System/tests/test_builder_bot.py::test_map_rejection PASSED  [ 40%]
Multi-Agent_System/tests/test_builder_bot.py::test_bom_command FAILED    [ 41%]
Multi-Agent_System/tests/test_chat_listener.py::test_initialization PASSED [ 42%]
Multi-Agent_System/tests/test_chat_listener.py::test_stop PASSED         [ 43%]
Multi-Agent_System/tests/test_chat_listener.py::test_listen_processing_messages PASSED [ 44%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_init_creates_dir PASSED [ 45%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_make_serializable PASSED [ 46%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_save_and_load PASSED [ 47%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_load_non_existent PASSED [ 48%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_load_corrupt_json PASSED [ 49%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_clear_prev_checkpoints PASSED [ 50%]
Multi-Agent_System/tests/test_checkpoints.py::TestCheckpoints::test_save_error_handling PASSED [ 50%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_decompose_to_rectangles PASSED [ 51%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_handle_command_start PASSED [ 52%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_handle_command_set PASSED [ 53%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_decide_logic PASSED [ 54%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_act_execution PASSED [ 55%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_scan_and_find_zones_mocked PASSED [ 56%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_scan_pausing PASSED [ 57%]
Multi-Agent_System/tests/test_explorer_bot.py::TestExplorerBot::test_resume_command PASSED [ 58%]
Multi-Agent_System/tests/test_integration_workflow.py::TestIntegrationWorkflow::test_workflow_execution_flow PASSED [ 59%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_valid_message PASSED [ 60%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_missing_fields PASSED [ 61%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_invalid_types PASSED [ 62%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_invalid_timestamp PASSED [ 63%]
Multi-Agent_System/tests/test_json_schema.py::test_validate_invalid_status PASSED [ 64%]
Multi-Agent_System/tests/test_message_bus.py::test_register_agent PASSED [ 65%]
Multi-Agent_System/tests/test_message_bus.py::test_subscribe_agent PASSED [ 66%]
Multi-Agent_System/tests/test_message_bus.py::test_subscribe_unregistered_agent_raises_error PASSED [ 66%]
Multi-Agent_System/tests/test_message_bus.py::test_publish_subscribe_delivery PASSED [ 67%]
Multi-Agent_System/tests/test_message_bus.py::test_publish_direct_delivery PASSED [ 68%]
Multi-Agent_System/tests/test_message_bus.py::test_receive_unregistered_raises_error PASSED [ 69%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_valid_command_with_params PASSED [ 70%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_command_with_string_and_int_params PASSED [ 71%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_invalid_command_formatting PASSED [ 72%]
Multi-Agent_System/tests/test_message_parser.py::test_parse_unknown_agent PASSED [ 73%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_process_bom_resets_inventory PASSED [ 74%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_decide_priorities PASSED [ 75%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_act_mine_physical PASSED [ 76%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_act_initial_mine PASSED [ 77%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_handle_command_start_manual PASSED [ 78%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_perceive_locks PASSED [ 79%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_is_zone_forbidden PASSED [ 80%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_handle_command_set_strategy PASSED [ 81%]
Multi-Agent_System/tests/test_miner_bot.py::TestMinerBot::test_load_strategy_dynamically PASSED [ 82%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_byte PASSED [ 83%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_short PASSED [ 83%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_int PASSED [ 84%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_long PASSED [ 85%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_float_double PASSED [ 86%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_string PASSED [ 87%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_int_array PASSED [ 88%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_long_array PASSED [ 89%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSimpleNBT::test_read_list PASSED [ 90%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_load_error PASSED [ 91%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_decode_block_data PASSED [ 92%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_get_blocks_and_bom PASSED [ 93%]
Multi-Agent_System/tests/test_schematic_parser.py::TestSchematicParser::test_get_blocks_nested_format PASSED [ 94%]
Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_grid_mine PASSED [ 95%]
Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_vertical_mine PASSED [ 96%]
Multi-Agent_System/tests/test_strategies.py::TestStrategies::test_vein_mine PASSED [ 97%]
Multi-Agent_System/tests/test_synchronization.py::TestSynchronization::test_ensure_agent_waits_for_idle PASSED [ 98%]
Multi-Agent_System/tests/test_unit_core.py::TestUnitCore::test_message_parser_init PASSED [ 99%]
Multi-Agent_System/tests/test_unit_core.py::TestUnitCore::test_message_bus_pub_sub PASSED [100%]

================================== FAILURES ===================================
_______________________ test_build_structure_task_pause _______________________

bot = <agents.builder_bot.BuilderBot object at 0x000002149DACEF30>

    @pytest.mark.asyncio
    async def test_build_structure_task_pause(bot):
        # Setup multiple blocks
        bot.context['blocks_to_build'] = [
            {'x':0, 'y':0, 'z':0, 'block': 'stone'},
            {'x':1, 'y':0, 'z':0, 'block': 'stone'}
        ]
        bot.context['target_position'] = (0, 0)
        bot.context['target_height'] = 10
        bot.context['build_index'] = 0
    
        # Mocking block id
        with patch('agents.builder_bot.get_block_id', return_value=1):
            # We want to pause after the first iteration?
            # The loop batches 5 blocks.
            # We can set paused=True in a side_effect of setBlock to simulate concurrent update
            def side_effect(*args):
                 bot.context['paused'] = True
    
            bot.mc.setBlock.side_effect = side_effect
    
            with patch('asyncio.sleep', new_callable=AsyncMock):
                await bot._build_structure_task()
    
        # Should have stopped after first batch (or partial batch if check is inside)
        # The check is at start of while loop.
        # Logic: loop -> batch (5) -> update index -> sleep -> loop
        # If we set pause inside batch, it finishes batch then pauses.
        assert bot.context['building_in_progress'] is False
        # If batch size is 5, it probably finished all 2 blocks in one go,
        # but let's test that 'paused' causing return.
    
        # Try Scenario 2: Started paused
        bot.context['paused'] = True
        bot.context['build_index'] = 0
        bot.context['blocks_to_build'] = [{'x':0}]
        await bot._build_structure_task()
>       assert bot.mc.setBlock.call_count <= 1 # Should verify previous run only
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert 2 <= 1
E        +  where 2 = <MagicMock name='mock.setBlock' id='2287567918608'>.call_count
E        +    where <MagicMock name='mock.setBlock' id='2287567918608'> = <MagicMock id='2287567825440'>.setBlock
E        +      where <MagicMock id='2287567825440'> = <agents.builder_bot.BuilderBot object at 0x000002149DACEF30>.mc

Multi-Agent_System\tests\test_builder_bot.py:222: AssertionError
______________________________ test_bom_command _______________________________

bot = <agents.builder_bot.BuilderBot object at 0x000002149C4A78F0>
mock_structure_class = <MagicMock id='2287567515968'>

    @pytest.mark.asyncio
    async def test_bom_command(bot, mock_structure_class):
        # Invalid plan
        bot.context['current_plan'] = "nonexistent"
        with patch('agents.builder_bot.get_all_structures', return_value={}):
            await bot.handle_command("bom")
>           assert "Estructura nonexistent no tiene BOM" in bot.mc.postToChat.call_args[0][0] or "No hay plan" in bot.mc.postToChat.call_args[0][0] or not bot.mc.postToChat.called
                                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: 'NoneType' object is not subscriptable

Multi-Agent_System\tests\test_builder_bot.py:260: TypeError
=============================== tests coverage ================================
______________ coverage: platform win32, python 3.12.10-final-0 _______________

Name                                                     Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------
Multi-Agent_System\src\agents\agent_factory.py              22      0   100%
Multi-Agent_System\src\agents\agent_manager.py              61      6    90%   40-42, 57, 87-88
Multi-Agent_System\src\agents\base_agent.py                103     10    90%   31, 35, 39, 90-91, 94-95, 103-105
Multi-Agent_System\src\agents\builder_bot.py               302    110    64%   38-41, 44-45, 49-58, 73-74, 94-105, 113, 124-125, 129-131, 157, 170-172, 200-207, 217-239, 248-249, 273-276, 328-340, 343-357, 360-371, 394-395, 415-418, 425-426, 430-439, 457-469
Multi-Agent_System\src\agents\explorer_bot.py              374    118    68%   22-30, 40-41, 60, 64-69, 81-82, 89-90, 209-253, 258, 277-279, 332-334, 338-341, 350-354, 382, 421, 424-426, 439-440, 445-448, 452, 454-456, 461-465, 471-485, 489-490, 504-505, 525-535, 563-577
Multi-Agent_System\src\agents\miner_bot.py                 326    140    57%   61-67, 70-71, 79, 85-87, 95, 108-111, 137, 150, 176-183, 187-188, 211-212, 220, 239, 242-249, 260, 277-290, 295-298, 301-304, 320-325, 328, 334-383, 386-393, 396-403, 406-412, 420-425, 428-430, 443-446, 455-462, 478-482
Multi-Agent_System\src\agents\state_model.py                 8      0   100%
Multi-Agent_System\src\agents\workflow_manager.py           67      4    94%   65, 69-71
Multi-Agent_System\src\messages\chat_listener.py            25      3    88%   42-44
Multi-Agent_System\src\messages\message_bus.py              58      6    90%   61-63, 88, 100, 109
Multi-Agent_System\src\messages\message_parser.py          122     54    56%   69-71, 75-76, 80-81, 106, 123-152, 156-178, 192-200
Multi-Agent_System\src\strategies\grid_strategy.py          40     10    75%   28-29, 46-49, 54-58
Multi-Agent_System\src\strategies\mining_strategy.py        12      1    92%   30
Multi-Agent_System\src\strategies\vein_strategy.py          71     28    61%   35-37, 51-74, 78-79, 83-84, 90, 112-113
Multi-Agent_System\src\strategies\vertical_strategy.py      39     10    74%   25, 45-47, 52-61
Multi-Agent_System\src\utils\block_translator.py            38      0   100%
Multi-Agent_System\src\utils\checkpoints.py                 53      2    96%   48, 84
Multi-Agent_System\src\utils\json_schema.py                 34      6    82%   30, 40, 44, 48, 62, 70
Multi-Agent_System\src\utils\logging.py                     52      9    83%   16-23, 50
Multi-Agent_System\src\utils\reflection.py                  64     10    84%   21-22, 41-42, 56-57, 76-77, 102-103
Multi-Agent_System\src\utils\schematic_parser.py           170      6    96%   25, 39, 41, 43, 48, 70
--------------------------------------------------------------------------------------
TOTAL                                                     2041    533    74%
Coverage XML written to file coverage.xml
=========================== short test summary info ===========================
FAILED Multi-Agent_System/tests/test_builder_bot.py::test_build_structure_task_pause
FAILED Multi-Agent_System/tests/test_builder_bot.py::test_bom_command - TypeE...
======================== 2 failed, 104 passed in 8.61s ========================
